---
title: "USA Rezessionswahrscheinlichkeit"
author: "Philipp Hauber"
date: "2 12 2019"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=6, #fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r}
# clear workspace
rm(list = ls())

# turn off scientific notation
options(scipen = 999)

# working directory
setwd("C:/Users/Philipp/Documents/GitHub/US-term-spread-rec-prob")
#setwd("C:/Users/Hauber/Documents/GitHub/US-term-spread-rec-prob")

# libraries
library(fredr)
library(purrr)
library(ggplot2)
library(tidyr)
library(dplyr)
library(lubridate)

# set API key for FRED
fredr_set_key("84efd638e2db29ef758e0d8e081a4c05")
```


# Motivation

# Literatur

# Daten

```{r}
# load yield curve data, recession indicator and Fed Board term premium from FRED #################
var_mnemonic <- c("USREC", "GS10", "TB3MS", "THREEFYTP10")
var_names <- c("nber_rec", "i10y", "i3m", "tp_board")
data_fred <- data.frame()
for (i in 1 : length(var_names)) {
    tmp <- fredr(series_id = var_mnemonic[i], 
                                 observation_start = as.Date("1950-01-01"),
                                 frequency = "q", 
                                 aggregation_method = "avg"
                 )
    
    tmp[, "series_id"] <- var_names[i]
    
    data_fred <- rbind(data_fred, tmp)
}


# load term spread data from NY Fed ################
data_nyfed_raw <- read.table("ACMTermPremium.csv", 
                   header = TRUE, 
                   sep = ";", 
                   blank.lines.skip = FALSE)

data_nyfed_raw$DATE <- dmy(data_nyfed_raw$DATE)

# select term premium on 10 year bond
data_nyfed <- data_nyfed_raw %>% rename(date = DATE, tp_d = ACMTP10) %>%
                            select(date, tp_d) %>% 
                            mutate(yy = year(date), qq = ceiling(month(date)/3)) %>%
                            group_by(yy, qq) %>%
                            summarise(tp_ny = round(mean(tp_d),2)) %>%
                            ungroup() %>% 
                            mutate(date = make_date(year = yy, month = 3*qq - 2)) %>%
                            select(-yy, -qq) %>%
                            select(date, tp_ny)

# # load term spread data from SF Fed ################
# data_sffed_raw <- read.table("FRBSF_Term_Model_Data.csv", 
#                    header = TRUE, 
#                    sep = ";", 
#                    blank.lines.skip = FALSE)
# 
# data_sffed_raw <- data_sffed_raw[21 : nrow(data_sffed_raw), ]
# 
# data_sffed_raw$DATE <- dmy(data_sffed_raw$DATE)
# 
# data_sffed <- data_sffed_raw %>% rename(date = DATE, tp_d = OTERMP10YR) %>%
#                                  select(date, tp_d) %>% 
#                                  mutate(yy = year(date), mm = month(date)) %>%
#                                  group_by(yy, mm) %>%
#                                  summarise(tp_sf = round(mean(tp_d),2)) %>%
#                                  ungroup() %>% 
#                                  mutate(date = make_date(year = yy, month = mm)) %>%
#                                  select(-yy, -mm) %>%
#                                  select(date, tp_sf)


# merge two datasets and create term-premium adjusted spread ########
data <- merge(spread(data_fred, series_id, value), data_nyfed, by = "date") %>% 
                mutate(i10y_tp_ny = i10y - tp_ny,
                       spr = i10y - i3m,
                       spr_tp = i10y - tp_ny - i3m) %>%
                gather(variable, value, -date)

```

## Zinsstrukturkurve

```{r}
data %>% filter(variable %in% c("i10y", "i3m")) %>%
         ggplot(aes(x = date, y = value, group = variable, col = variable))+
         geom_line()
```

## NBER-Rezessionsindikator

```{r}
data %>% filter(variable %in% c("nber_rec")) %>%
         ggplot(aes(x = date, y = value, group = variable, col = variable))+
         geom_point()
```

## Laufzeitprämien

```{r}
data %>% filter(variable %in% c("tp_ny", "tp_board")) %>%
         ggplot(aes(x = date, y = value, group = variable, col = variable))+
         geom_line()
```


# Schätzung

## Probit-Modelle

$$rec_{t+h} = \alpha_0 + \alpha_1 spread_{t} + e_t$$

Drei Spezifikationen **ZK** (Zinstrukturkurve), **ZK_TP** (Zinsstrukturkurve + Laufzeitprämie), **ZK_TP_t** (Zinstrukturkurve + Laufzeitprämie + Trend)

```{r}
# Nh <- 4 # forecast horizon
# date_eval <- "2015-10-01"
# 
# data_tmp <- data %>% filter(variable %in% c("nber_rec", "spr", "spr_tp", "tp_ny"),
#                             date <= date_eval) %>%
#                             select(date, variable, value) %>%
#                             spread(variable, value) %>%
#                             mutate(lag_spr = lag(spr, Nh),
#                                    lag_spr_tp = lag(spr_tp, Nh),
#                                    lag_tp = lag(tp_ny, Nh),
#                                    trend = 1 : n()
#                                    )
# 
# 
# data_estim <- data_tmp %>% filter(date < date_eval)
# data_eval <- data_tmp %>% filter(date == date_eval)
# 
# zk <- glm(nber_rec ~ lag_spr, 
#                     family = binomial(link = "probit"), 
#                     data = data_estim)
# 
# zk_tp <- glm(nber_rec ~ lag_spr + lag_tp, 
#                     family = binomial(link = "probit"), 
#                     data = data_estim)
# 
# zk_tp_t <- glm(nber_rec ~ lag_spr + lag_tp + trend, 
#                     family = binomial(link = "probit"), 
#                     data = data_estim)
# 
# forecasts <- data.frame(fore_zk = predict(zk, data_eval, type = "response"),
#                         fore_zk_tp = predict(zk_tp, data_eval, type = "response"),
#                         fore_zk_tp_t = predict(zk_tp_t, data_eval, type = "response"),
#                         actual = data_eval$nber_rec,
#                         date = data_eval$date)
```


## Set-up

```{r, echo = TRUE}
Nh <- 4 # forecast horizon
sample_start <- "1962-01-01"
eval_start <- "1978-01-01"
eval_end <- "2017-10-01"
```

## Results

```{r}
df_fore <- data.frame()

for (date_eval in seq(from = as.Date(eval_start), to = as.Date(eval_end), by = "quarters"))  {
    # data 
    data_tmp <- data %>% filter(variable %in% c("nber_rec", "spr", "spr_tp", "tp_ny"),
                                date <= date_eval, date > sample_start) %>%
                            select(date, variable, value) %>%
                            spread(variable, value) %>%
                            mutate(lag_spr = lag(spr, Nh),
                                   lag_spr_tp = lag(spr_tp, Nh),
                                   lag_tp = lag(tp_ny, Nh),
                                   trend = 1 : n()
                                   )
    
    data_estim <- data_tmp %>% filter(date < date_eval)
    data_eval <- data_tmp %>% filter(date == date_eval)
    
    # models
    zk <- glm(nber_rec ~ lag_spr, 
                    family = binomial(link = "probit"), 
                    data = data_estim)

    zk_tp <- glm(nber_rec ~ lag_spr + lag_tp, 
                        family = binomial(link = "probit"), 
                        data = data_estim)
    
    zk_tp_t <- glm(nber_rec ~ lag_spr + lag_tp + trend, 
                        family = binomial(link = "probit"), 
                        data = data_estim)
    
    # forecasts
    df_fore <- rbind(df_fore,
                       data.frame(fore_zk = round(predict(zk, data_eval, type = "response"), 3),
                                  fore_zk_tp = round(predict(zk_tp, data_eval, type = "response"), 3),
                                  fore_zk_tp_t = round(predict(zk_tp_t, data_eval, type = "response"), 3),
                                  actual = data_eval$nber_rec,
                                  date = data_eval$date)
                       )
}

data_tmp <- data %>% filter(variable == "nber_rec",  date >eval_start, date <= eval_end) %>% 
                     mutate(ind_rec_start = lag(value) == 0 & value == 1,
                            ind_rec_end = lag(value) == 1 & value == 0) %>%
                     filter(ind_rec_start == TRUE | ind_rec_end == TRUE) 

df_rec <- data.frame(start =  data_tmp$date[data_tmp$ind_rec_start == TRUE],
                     end = data_tmp$date[data_tmp$ind_rec_end == TRUE])

# subtract three months from end 
# my way of finding the end of recession is actually the first quarter in which there is no longer a recession

df_rec <- df_rec %>% mutate(end2 = end %m-% months(3)) %>% 
                     select(start, end2) %>% 
                     rename(end = end2) 

# plot predicted recession probabilites and recession shading
df_fore %>% select(date, fore_zk, fore_zk_tp, fore_zk_tp_t) %>%
            gather(model, value, -date) %>% 
            ggplot()+
            geom_line(aes(x = date, y = value, group = model, col = model)) +
            theme_bw()+
            geom_rect(data = df_rec, 
                      aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf),
                      fill='grey', alpha=0.4
                     )
```

# Evaluierung

## ROC-Kurve

```{r}
library(pROC)

roc_zk <- roc(df_fore, actual, fore_zk,
              ret = c("roc", "coords", "all_coords"))

roc_zk_tp <- roc(df_fore, actual, fore_zk_tp,
                 ret = c("roc", "coords", "all_coords"))

roc_zk_tp_t <- roc(df_fore, actual, fore_zk_tp_t,
                   ret = c("roc", "coords", "all_coords"))

ggroc(list(zk = roc_zk, zk_tp = roc_zk_tp, zk_tp_t = roc_zk_tp_t), legacy.axes = TRUE)
```

## Fläche unter der ROC-Kurve (AUC)

| Modell | AUC |
| ------ | --- | 
| ZK | `r round(roc_zk$auc,2)` | 
| ZK + TP | `r round(roc_zk_tp$auc,2)` | 
| ZK + TP + trend| `r round(roc_zk_tp_t$auc,2)` | 

## Bester Schwellenwert?


